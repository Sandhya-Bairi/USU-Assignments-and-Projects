package com.usu.drawingGUI;

import java.awt.Color;
import java.awt.Graphics2D;
import java.awt.Point;
import java.util.ArrayList;
import java.util.List;

import javax.swing.JPanel;

import com.usu.draw.Shape;
import com.usu.draw.ShapeFactory;

public class DrawingPalette {

	Shape shape;
	
	public ShapeFactory shapeFactory;
	
	private List<Shape> shapes = new ArrayList<Shape>();
	
	private Object lock = new Object();
	
	public boolean isDirty;
	
	public int shapeCount = shapes.size();
	
	 public void add(Shape shape) {
         if (shape != null) {
        	 synchronized(lock) {
        		 shapes.add(shape);
                 isDirty = true;
             }
         }
     }
	 
	 public void clear() {
		 synchronized(lock) {
             shapes.clear();
             isDirty = true;
         }
     }
	 
	 public void removeShape(Shape shape) {
         if (shape != null) {
        	 synchronized(lock) {
                 if (this.shape == shape)
                	 this.shape = null;
                 shapes.remove(shape);
                 isDirty = true;
             }
         }
     }
	 
	 public boolean draw(Graphics2D graphics, JPanel mainPanel) {
         boolean didARedraw = false;
         synchronized(lock) {
             if (isDirty) {
                 graphics.setColor(Color.WHITE);
                 for(Shape shape : shapes)
                	 shape.draw(graphics, mainPanel);
                 isDirty = true;
                 didARedraw = true;
             }
         }
         return didARedraw;
     }
	 
	 public Shape findShapeAtPosition(Point location) {
         Shape result;
         synchronized(lock) {
        	 for(Shape shape : shapes){
        		if(location.x >= shape.getLocation().x && location.x < (shape.getLocation().x + shape.getSize().width) && location.y >= shape.getLocation().y && location.y < (shape.getLocation().y + shape.getSize().height)) {
        			result = shape;
        			return result;
        		}
        	 }
         }
         return null;
     }
	 
	 public void deleteAllSelected() {
		 synchronized(lock) {
             shapes.removeIf(s -> s.isSelected);
         }
     }
	 
	 public void loadFromString(String stream) {
		 /*ShapeExtrinsicState extrinsicStates = (List<ShapeExtrinsicState>)JsonSerializer.ReadObject(stream);
         if (extrinsicStates == null) return;

         synchronized(lock) {
             shapes.clear();
             for(ShapeExtrinsicState extrinsicState : extrinsicStates) {
                 Shape shape = shapeFactory.getShape(extrinsicState);
                 shapes.add(shape);
             }
             isDirty = true;
         }*/
     }
	 
	 public void save(String fileName) {
         /*List<ShapeExtrinsicState> extrinsicStates = new ArrayList<ShapeExtrinsicState>();
         synchronized(lock) {
             for(Shape shape : shapes) {
                 ShapeWithAllState shapewithAllState = (ShapeWithAllState)shape;
                 if(shapewithAllState != null)
                     extrinsicStates.add(shapewithAllState.extrinsicState);                    
             }
         }
         JsonSerializer.WriteObject(stream, extrinsicStates);*/
     }
	 
	 public void deselectAll() {
		 synchronized(lock) {
             for(Shape shape : shapes)
                 shape.isSelected = false;
             isDirty = true;
         }    
     }
	 
	 public void drawRectangle(Point location, JPanel mainPanel) {
		 for(Shape shape : shapes){
     		if(location.x >= shape.getLocation().x && location.x < (shape.getLocation().x + shape.getSize().width) && location.y >= shape.getLocation().y && location.y < (shape.getLocation().y + shape.getSize().height)) {
     			mainPanel.getGraphics().drawRect(shape.getLocation().x, shape.getLocation().y, shape.getSize().width, shape.getSize().height);
     		}
     	 }
	 }
}
